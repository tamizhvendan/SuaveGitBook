<h1>A slightly more complex example: routing HTTP requests</h1>
<p>Most .NET web frameworks are based on the object-oriented paradigm. This means that you have a class called something like CheesesController or CheesesModule. The methods in that class are then associated with url routes, with the most common routing methods being convention based, attribute-based (e.g. adding attributes like <code>[Route("cheeses/{cheeseId}/taste")]</code> and <code>[HttpGet]</code>) or some sort of global routing table.</p>
<p>Suave is designed to fit in with F#'s functional programming paradigm, so routing does not use any of these routing methods. Instead routing takes place using a single function, itself composed from many smaller functions. This function has the signature <code>WebPart</code>:</p>
<pre class="fssnip highlighted"><div lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="t">WebPart</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="t">HttpContext</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="t">Async</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="t">HttpContext</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="t">option</span><span class="o">&gt;</span>
</div></pre>

<p>This function has a single parameter of type <code>HttpContext</code>. This is an F# record type that includes the HTTP request, the HTTP response, and a few other things. This should be pretty familiar to anyone who has done any web programming before.</p>
<p>A WebPart function returns an asynchronous workflow which itself ultimately returns an <code>HttpContext option</code>. Asynchronous workflows are hopefully already somewhat familiar. The <code>HttpContext option</code> returned by the asynchronous workflow is either <code>Some HttpContext</code> record or <code>None</code>, and it is the option that is used to determine routing. Here is a web server with some simple routing logic. You can ignore the <code>&gt;=&gt;</code> operator and the exact workings of <code>choose</code> for now (both are explained in more detail later), just focus on the tree-like structure of the code:</p>
<pre class="fssnip highlighted"><div lang="fsharp"><span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="i">Suave</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 7)" onmouseover="showTip(event, 'fs5', 7)" class="i">Suave</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 8)" onmouseover="showTip(event, 'fs6', 8)" class="i">Filters</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 9)" onmouseover="showTip(event, 'fs5', 9)" class="i">Suave</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 10)" onmouseover="showTip(event, 'fs7', 10)" class="i">Operators</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 11)" onmouseover="showTip(event, 'fs5', 11)" class="i">Suave</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 12)" onmouseover="showTip(event, 'fs8', 12)" class="i">Successful</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs9', 13)" onmouseover="showTip(event, 'fs9', 13)" class="f">app</span> <span class="o">=</span>
  <span onmouseout="hideTip(event, 'fs10', 14)" onmouseover="showTip(event, 'fs10', 14)" class="f">choose</span>
    [ <span onmouseout="hideTip(event, 'fs11', 15)" onmouseover="showTip(event, 'fs11', 15)" class="f">GET</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs10', 16)" onmouseover="showTip(event, 'fs10', 16)" class="f">choose</span>
        [ <span onmouseout="hideTip(event, 'fs12', 17)" onmouseover="showTip(event, 'fs12', 17)" class="f">path</span> <span class="s">&quot;/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs13', 18)" onmouseover="showTip(event, 'fs13', 18)" class="f">OK</span> <span class="s">&quot;Hello GET&quot;</span>
          <span onmouseout="hideTip(event, 'fs12', 19)" onmouseover="showTip(event, 'fs12', 19)" class="f">path</span> <span class="s">&quot;/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs13', 20)" onmouseover="showTip(event, 'fs13', 20)" class="f">OK</span> <span class="s">&quot;Good bye GET&quot;</span> ]
      <span onmouseout="hideTip(event, 'fs14', 21)" onmouseover="showTip(event, 'fs14', 21)" class="f">POST</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs10', 22)" onmouseover="showTip(event, 'fs10', 22)" class="f">choose</span>
        [ <span onmouseout="hideTip(event, 'fs12', 23)" onmouseover="showTip(event, 'fs12', 23)" class="f">path</span> <span class="s">&quot;/hello&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs13', 24)" onmouseover="showTip(event, 'fs13', 24)" class="f">OK</span> <span class="s">&quot;Hello POST&quot;</span>
          <span onmouseout="hideTip(event, 'fs12', 25)" onmouseover="showTip(event, 'fs12', 25)" class="f">path</span> <span class="s">&quot;/goodbye&quot;</span> <span class="o">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs13', 26)" onmouseover="showTip(event, 'fs13', 26)" class="f">OK</span> <span class="s">&quot;Good bye POST&quot;</span> ] ]

<span onmouseout="hideTip(event, 'fs15', 27)" onmouseover="showTip(event, 'fs15', 27)" class="f">startWebServer</span> <span onmouseout="hideTip(event, 'fs16', 28)" onmouseover="showTip(event, 'fs16', 28)" class="i">defaultConfig</span> <span onmouseout="hideTip(event, 'fs9', 29)" onmouseover="showTip(event, 'fs9', 29)" class="f">app</span>
</div></pre>

<p>By using <code>choose</code> we execute different logic depending on whether the request was a GET or a POST, and depending on whether the url was /hello or /goodbye. If a request matches a given path in the decision tree, <code>choose</code> will return <code>Some HttpContext</code>, if it doesn't, <code>choose</code> will return <code>None</code>. The end result is that when someone makes a request the server will walk down this tree looking for the first part that returns <code>Some HttpContext</code>, and then return it to the client. If no part of the tree returns <code>Some HttpContext</code> then the result is an exception. You can can also add a default route which returns a 404 page.</p>
<p>The server won't evalute the entire data structure for every request, only the actual decisions, so there is no need to be concerned about performance.</p>
<h2>Handling Errors</h2>
<p>How does the <code>userState</code> work when there's an error?</p>
<p>Even though the web part that created the state succeed earlier in the pipeline, there's no way to get at it later. Whenever there's an exception, Suave will terminate the currently running web part and jump into the exception handler. No, your best bet is to avoid throwing exceptions and working with types and values for control flow instead. BestPracticeâ„¢</p>


<div class="tip" id="fs1">Multiple items<br />module WebPart<br /><br />from Suave<br /><br />--------------------<br />type WebPart = HttpContext -&gt; Async&lt;HttpContext option&gt;<br /><br />Full name: temp.WebPart<br /><br />--------------------<br />type WebPart&lt;&#39;a&gt; = &#39;a -&gt; Async&lt;&#39;a option&gt;<br /><br />Full name: Suave.WebPart.WebPart&lt;_&gt;</div>
<div class="tip" id="fs2">Multiple items<br />module HttpContext<br /><br />from Suave.Http<br /><br />--------------------<br />type HttpContext =<br />&#160;&#160;{request: HttpRequest;<br />&#160;&#160;&#160;runtime: HttpRuntime;<br />&#160;&#160;&#160;connection: Connection;<br />&#160;&#160;&#160;userState: Map&lt;string,obj&gt;;<br />&#160;&#160;&#160;response: HttpResult;}<br />&#160;&#160;member clientIp : trustProxy:bool -&gt; sources:string list -&gt; IPAddress<br />&#160;&#160;member clientPort : trustProxy:bool -&gt; sources:string list -&gt; Port<br />&#160;&#160;member clientProto : trustProxy:bool -&gt; sources:string list -&gt; string<br />&#160;&#160;member clientIpTrustProxy : IPAddress<br />&#160;&#160;member clientPortTrustProxy : Port<br />&#160;&#160;member clientProtoTrustProxy : string<br />&#160;&#160;member isLocal : bool<br />&#160;&#160;static member clientIp_ : Property&lt;HttpContext,IPAddress&gt;<br />&#160;&#160;static member clientPort_ : Property&lt;HttpContext,Port&gt;<br />&#160;&#160;static member clientProto_ : Property&lt;HttpContext,string&gt;<br />&#160;&#160;static member connection_ : Property&lt;HttpContext,Connection&gt;<br />&#160;&#160;static member isLocal_ : Property&lt;HttpContext,bool&gt;<br />&#160;&#160;static member request_ : Property&lt;HttpContext,HttpRequest&gt;<br />&#160;&#160;static member response_ : Property&lt;HttpContext,HttpResult&gt;<br />&#160;&#160;static member runtime_ : Property&lt;HttpContext,HttpRuntime&gt;<br />&#160;&#160;static member userState_ : Property&lt;HttpContext,Map&lt;string,obj&gt;&gt;<br /><br />Full name: Suave.Http.HttpContext</div>
<div class="tip" id="fs3">Multiple items<br />module Async<br /><br />from YoLo<br /><br />--------------------<br />type Async<br />static member AsBeginEnd : computation:(&#39;Arg -&gt; Async&lt;&#39;T&gt;) -&gt; (&#39;Arg * AsyncCallback * obj -&gt; IAsyncResult) * (IAsyncResult -&gt; &#39;T) * (IAsyncResult -&gt; unit)<br />static member AwaitEvent : event:IEvent&lt;&#39;Del,&#39;T&gt; * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt; (requires delegate and &#39;Del :&gt; Delegate)<br />static member AwaitIAsyncResult : iar:IAsyncResult * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member AwaitTask : task:Task -&gt; Async&lt;unit&gt;<br />static member AwaitTask : task:Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;<br />static member AwaitWaitHandle : waitHandle:WaitHandle * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member CancelDefaultToken : unit -&gt; unit<br />static member Catch : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;Choice&lt;&#39;T,exn&gt;&gt;<br />static member Choice : computations:seq&lt;Async&lt;&#39;T option&gt;&gt; -&gt; Async&lt;&#39;T option&gt;<br />static member FromBeginEnd : beginAction:(AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg:&#39;Arg1 * beginAction:(&#39;Arg1 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * beginAction:(&#39;Arg1 * &#39;Arg2 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * arg3:&#39;Arg3 * beginAction:(&#39;Arg1 * &#39;Arg2 * &#39;Arg3 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromContinuations : callback:((&#39;T -&gt; unit) * (exn -&gt; unit) * (OperationCanceledException -&gt; unit) -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Ignore : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;unit&gt;<br />static member OnCancel : interruption:(unit -&gt; unit) -&gt; Async&lt;IDisposable&gt;<br />static member Parallel : computations:seq&lt;Async&lt;&#39;T&gt;&gt; -&gt; Async&lt;&#39;T []&gt;<br />static member RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:CancellationToken -&gt; &#39;T<br />static member Sleep : millisecondsDueTime:int -&gt; Async&lt;unit&gt;<br />static member Start : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions * ?cancellationToken:CancellationToken -&gt; Task&lt;&#39;T&gt;<br />static member StartChild : computation:Async&lt;&#39;T&gt; * ?millisecondsTimeout:int -&gt; Async&lt;Async&lt;&#39;T&gt;&gt;<br />static member StartChildAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions -&gt; Async&lt;Task&lt;&#39;T&gt;&gt;<br />static member StartImmediate : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartWithContinuations : computation:Async&lt;&#39;T&gt; * continuation:(&#39;T -&gt; unit) * exceptionContinuation:(exn -&gt; unit) * cancellationContinuation:(OperationCanceledException -&gt; unit) * ?cancellationToken:CancellationToken -&gt; unit<br />static member SwitchToContext : syncContext:SynchronizationContext -&gt; Async&lt;unit&gt;<br />static member SwitchToNewThread : unit -&gt; Async&lt;unit&gt;<br />static member SwitchToThreadPool : unit -&gt; Async&lt;unit&gt;<br />static member TryCancelled : computation:Async&lt;&#39;T&gt; * compensation:(OperationCanceledException -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member CancellationToken : Async&lt;CancellationToken&gt;<br />static member DefaultCancellationToken : CancellationToken<br /><br />Full name: Microsoft.FSharp.Control.Async<br /><br />--------------------<br />type Async&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Async&lt;_&gt;</div>
<div class="tip" id="fs4">type &#39;T option = Option&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.option&lt;_&gt;</div>
<div class="tip" id="fs5">namespace Suave</div>
<div class="tip" id="fs6">module Filters<br /><br />from Suave</div>
<div class="tip" id="fs7">module Operators<br /><br />from Suave</div>
<div class="tip" id="fs8">module Successful<br /><br />from Suave</div>
<div class="tip" id="fs9">val app : WebPart&lt;HttpContext&gt;<br /><br />Full name: temp.app</div>
<div class="tip" id="fs10">val choose : options:WebPart&lt;&#39;a&gt; list -&gt; WebPart&lt;&#39;a&gt;<br /><br />Full name: Suave.WebPart.choose</div>
<div class="tip" id="fs11">val GET : WebPart<br /><br />Full name: Suave.Filters.GET</div>
<div class="tip" id="fs12">val path : pathAfterDomain:string -&gt; WebPart<br /><br />Full name: Suave.Filters.path</div>
<div class="tip" id="fs13">val OK : body:string -&gt; WebPart<br /><br />Full name: Suave.Successful.OK</div>
<div class="tip" id="fs14">val POST : WebPart<br /><br />Full name: Suave.Filters.POST</div>
<div class="tip" id="fs15">val startWebServer : config:SuaveConfig -&gt; webpart:WebPart -&gt; unit<br /><br />Full name: Suave.Web.startWebServer</div>
<div class="tip" id="fs16">val defaultConfig : SuaveConfig<br /><br />Full name: Suave.Web.defaultConfig</div>
